name: Integrate to Game Hub

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  integrate:
    # Set repository variable ENABLE_YOUR_GAME_GAMEHUB_INTEGRATION=true to activate this job.
    if: ${{ (github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch') && vars.ENABLE_YOUR_GAME_GAMEHUB_INTEGRATION == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout game repo
        uses: actions/checkout@v4
        with:
          path: game-repo

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Transform game structure
        run: |
          cd game-repo
          node scripts/transform-for-gamehub.mjs

      - name: Checkout Game Hub
        uses: actions/checkout@v4
        with:
          repository: jsevenheck/game-hub # TODO: update to your game-hub repo
          path: game-hub
          token: ${{ secrets.GAMEHUB_PAT }}

      - name: Copy transformed game
        run: |
          rm -rf game-hub/games/YOUR_GAME_ID
          cp -r game-repo/game-export/YOUR_GAME_ID game-hub/games/

      - name: Update lockfile
        working-directory: game-hub
        run: pnpm install --no-frozen-lockfile

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GAMEHUB_PAT }}
          path: game-hub
          commit-message: 'feat(games): update YOUR_GAME_ID from ${{ github.event.workflow_run.head_sha || github.sha }}'
          branch: integrate/YOUR_GAME_ID-${{ github.run_number }}
          delete-branch: true
          title: 'Update Your Game'
          body: |
            ## Your Game Update

            **Source Commit**: ${{ github.repository }}@${{ github.event.workflow_run.head_sha || github.sha }}
            **Triggered by**: @${{ github.event.workflow_run.head_commit.author.name || github.actor }}
            **CI Run**: ${{ github.event.workflow_run.html_url || format('{0}/{1}/actions/runs/{2}', github.server_url, github.repository, github.run_id) }}

            ### Changes
            - Automatic integration from YOUR_GAME_ID repository
            - [x] All tests passed in source repo (CI workflow succeeded)

            ### Review Checklist
            - [ ] Game structure follows conventions
            - [ ] No breaking changes to platform contracts
            - [ ] Game registry updated if needed
            - [ ] E2E tests pass in Game Hub
